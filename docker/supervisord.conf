# Supervisord Configuration for CustomGPTs Container
#
# Manages 5 processes with priority-based startup ordering:
#   Priority 10: Xvfb       — Virtual X11 display (must start first)
#   Priority 20: x11vnc     — VNC server (needs Xvfb display)
#   Priority 30: noVNC      — Browser-based VNC client (needs x11vnc)
#   Priority 40: customgpts — API server with Chromium (needs Xvfb display)
#   Priority 50: cloudflared — Cloudflare tunnel (needs API server)
#
# All process output goes to stdout/stderr (Docker logs).

[supervisord]
nodaemon=true
user=root
logfile=/dev/null
logfile_maxbytes=0
pidfile=/var/run/supervisord.pid

# ── Xvfb: Virtual X11 Display ───────────────────────────────────
# Creates a virtual framebuffer at display :99 with configurable resolution.
# Chromium renders here instead of requiring a physical monitor.
[program:xvfb]
command=Xvfb :99 -screen 0 %(ENV_DISPLAY_WIDTH)sx%(ENV_DISPLAY_HEIGHT)sx24 -ac +extension GLX +render -noreset
autostart=true
autorestart=true
priority=10
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0

# ── x11vnc: VNC Server ──────────────────────────────────────────
# Exposes the Xvfb display via VNC protocol on port 5900.
# -forever: don't exit after first client disconnects
# -shared: allow multiple simultaneous VNC connections
# -nopw: no password by default (VNC_ARGS adds -rfbauth if VNC_PASSWORD is set)
[program:x11vnc]
command=x11vnc -display :99 -forever -shared -nopw %(ENV_VNC_ARGS)s -xkb
autostart=true
autorestart=true
priority=20
startsecs=3
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0

# ── noVNC: Browser-Based VNC Client ─────────────────────────────
# Provides a web-based VNC viewer at http://localhost:6080.
# Uses websockify to bridge WebSocket connections to the VNC server.
[program:novnc]
command=websockify --web /usr/share/novnc 6080 localhost:5900
autostart=true
autorestart=true
priority=30
startsecs=5
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0

# ── CustomGPTs API Server ───────────────────────────────────────
# Launches the OpenAI-compatible API server on port 5124.
# --verbose enables debug logging for troubleshooting.
# DISPLAY=:99 tells Chromium to use the Xvfb virtual display.
[program:customgpts]
command=customgpts serve --verbose
autostart=true
autorestart=true
priority=40
startsecs=10
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
environment=DISPLAY=":99"

# ── Cloudflared Tunnel ──────────────────────────────────────────
# Establishes a Cloudflare tunnel to expose the API server externally
# at customgpts.rohitsoni.com without port forwarding or public IP.
# Uses config-file-based tunnel with credentials from the capi_multi project.
[program:cloudflared]
command=cloudflared tunnel --no-autoupdate --config /etc/cloudflared/config.yml run
autostart=true
autorestart=true
priority=50
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
